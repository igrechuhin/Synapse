---
globs: tests/**/*.py
alwaysApply: false
---

# Testing Standards (MANDATORY)

**ENFORCEMENT**: CI MUST fail on violations. Applies to all test files and to any project/language/code.

## Core Principles

- **AAA required**: Arrange-Act-Assert structure in every test.
- **Deterministic**: No flakiness; avoid time-based sleeps and randomness without seeding.
- **Performance**: Individual tests complete in <10s; suites stay lean.
- **Coverage**: Minimum 90% coverage required (MANDATORY - NO EXCEPTIONS).
  - New code paths must be covered; critical logic needs edge/error cases.
  - "Pre-existing condition" is NOT a valid excuse for low coverage.
  - Coverage threshold failures MUST be fixed before commit.

## Edge Cases (MANDATORY - ALL PROJECTS/LANGUAGES)

When adding tests, **always ensure to cover all edge cases**. This applies to any project, language, or codebase.

- **Boundary conditions**: Min/max values, empty collections, zero, null/nil/None, single-element lists, exact thresholds.
- **Error handling**: Invalid inputs, malformed data, missing required fields, wrong types, out-of-range values.
- **Empty and degenerate states**: Empty strings, empty arrays, no-op inputs, identity cases.
- **Success and failure paths**: Both happy path and every documented error path must have tests.
- **Integration edge cases**: Timeouts, partial failures, concurrent access, resource exhaustion where relevant.

Do not limit tests to the happy path; edge-case coverage is mandatory for new and modified behavior.

## Skips and Marks

- Skips must include explicit reason and issue/ticket reference.
- Do not use broad `xfail` without a linked defect and a removal plan.
- No unconditional skips for entire modules; scope skips narrowly.

## Fixtures and Data

- Reuse shared fixtures in `conftest.py`; avoid duplicated setup.
- Isolate state between tests; clean up external resources.
- Prefer factories/builders over ad-hoc dicts for complex payloads.

## Async Tests

- Use `pytest.mark.asyncio` (or configured async plugin) on async tests.
- Avoid blocking calls inside async tests; offload with executors when needed.

## Assertions

- Assert behavior, not implementation details; include clear failure messages for complex checks.
- Validate both success and failure/error paths for public APIs.

## Testing Private/Internal Functions (FORBIDDEN)

**CRITICAL**: Private/internal functions (implementation details) MUST NOT be tested directly.

**FORBIDDEN:**

- ❌ Importing private/internal functions in test files
- ❌ Using type checker suppressions or workarounds to test private functions
- ❌ Testing private implementation details directly
- ❌ Bypassing encapsulation to test internal behavior

**REQUIRED:**

- ✅ Test private/internal functions through public interface only
- ✅ If private function needs direct testing, make it public or extract to separate module
- ✅ Test behavior, not implementation details
- ✅ Verify functionality through public API contracts
